plugins:
  source:
    - module: intake_postgres
    - dir: !template '{{ CATALOG_DIR }}/plugin_dir'

sources:
  # In this case, each "source" is the name of a dataset; for convenience, it
  # shares the name of the table where the data resides - but this need not be
  # the case (and will probably not be the case very often).
  - name: sample1
    driver: postgres
    args:
      uri: 'postgresql://postgres@localhost:5432/postgres'
      sql_expr: 'select * from sample1'

  - name: sample2_1
    driver: postgres
    args:
      uri: 'postgresql://postgres@localhost:5432/postgres'
      sql_expr: 'select * from sample2_1'

  - name: sample2_2
    driver: postgres
    args:
      uri: 'postgresql://postgres@localhost:5432/postgres'
      sql_expr: 'select * from sample2_2'

  - name: sample2
    driver: postgres
    args:
      uri: 'postgresql://postgres@localhost:5432/postgres'
      sql_expr: |
        select coalesce(a.name, b.name) as name,
               coalesce(a.score, b.score) as score,
               coalesce(a.rank, b.rank) as rank
        from sample2_1 a full outer join sample2_2 b
        on a.name = b.name

  - name: points
    driver: postgres
    args:
      uri: 'postgresql://postgres@localhost:5432/postgres'
      sql_expr: |
        select * from points

  - name: multipoints
    driver: postgres
    args:
      uri: 'postgresql://postgres@localhost:5432/postgres'
      sql_expr: |
        select * from multipoints

  - name: lines
    driver: postgres
    args:
      uri: 'postgresql://postgres@localhost:5432/postgres'
      sql_expr: |
        select * from lines

  - name: multilines
    driver: postgres
    args:
      uri: 'postgresql://postgres@localhost:5432/postgres'
      sql_expr: |
        select * from multilines

  - name: polygons
    driver: postgres
    args:
      uri: 'postgresql://postgres@localhost:5432/postgres'
      sql_expr: |
        select * from polygons

  - name: multipolygons
    driver: postgres
    args:
      uri: 'postgresql://postgres@localhost:5432/postgres'
      sql_expr: |
        select * from multipolygons

  - name: triangles
    driver: postgres
    args:
      uri: 'postgresql://postgres@localhost:5432/postgres'
      sql_expr: |
        select * from triangles

  - name: jinja2_shell
    driver: postgres
    args:
      uri: !template 'postgresql://postgres@localhost:{{ shell("echo 5432") }}/{{ shell("echo postgres") }}'
      sql_expr: |
        select * from sample1

  - name: jinja2_env
    driver: postgres
    args:
      uri: !template 'postgresql://postgres@localhost:{{ env("DBPORT") }}/{{ env("DBNAME") }}'
      sql_expr: |
        select * from sample1

  - name: jinja2_shell_and_env
    driver: postgres
    args:
      uri: !template 'postgresql://postgres@localhost:{{ shell("echo 5432") }}/{{ env("DBNAME") }}'
      sql_expr: |
        select * from sample1

  - name: jinja2_params_with_env
    parameters:
      port:
        description: Database port
        type: int
        default: 5432
        allowed: 1024-65535
      dbname:
        description: Database name
        type: str
        default: postgres
      username:
        description: Database username
        type: str
        default: postgres
      address:
        description: Database server address
        type: hostname  # IP?
        default: localhost
    driver: postgres
    args:
      uri: !template 'postgresql://{{ username }}{{ env(DB_PASSWD) }}@{{ address }}:{{ port }}/{{ dbname }}'
      sql_expr: |
        select * from sample1
